DECLARE @START_DATE DATE,
@END_DATE DATE,
@TASK INT

SELECT START_DATE, END_DATE
INTO #TEMP
FROM PROJECTS
WHERE 1=2

DECLARE CUR CURSOR FOR 
SELECT TASK_ID, START_DATE, END_DATE
FROM PROJECTS
ORDER BY START_DATE

OPEN CUR

FETCH NEXT FROM CUR
INTO @TASK, @START_DATE, @END_DATE

WHILE @@FETCH_STATUS = 0
BEGIN
--SELECT @TASK, @START_DATE, @END_DATE

IF NOT EXISTS (SELECT TOP 1 1 FROM #TEMP WHERE END_DATE = @START_DATE)
BEGIN
    INSERT INTO #TEMP VALUES(@START_DATE, @END_DATE)
END
ELSE
BEGIN
UPDATE #TEMP
SET END_DATE = @END_DATE
WHERE END_DATE = @START_DATE
END
--SELECT '----------TEMP-----------' 
--SELECT * FROM #TEMP
--SELECT '--------END-------------'

FETCH NEXT FROM CUR
INTO @TASK, @START_DATE, @END_DATE

END     
CLOSE CUR;    
DEALLOCATE CUR;  


SELECT * FROM #TEMP
ORDER BY DATEDIFF(DAY, END_DATE,START_DATE) DESC, START_DATE ASC

